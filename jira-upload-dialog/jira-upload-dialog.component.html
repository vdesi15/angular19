<p-dialog 
  [header]="dialogTitle()" 
  [visible]="visible" 
  [modal]="true" 
  [style]="{ width: '600px' }"
  [height]="uploadState().showExecutions ? '700px' : 'auto'"
  [maximizable]="false"
  [closable]="true"
  [draggable]="true"
  [resizable]="false"
  styleClass="jira-upload-dialog"
  (onHide)="onDialogHide()">

  <div class="jira-dialog-content">
    
    <!-- ================================ -->
    <!-- SUCCESS/ERROR MESSAGES -->
    <!-- ================================ -->
    
    @if (uploadState().successMessage) {
      <p-message 
        severity="success" 
        [text]="uploadState().successMessage"
        [closable]="true"
        (onClose)="clearMessages()"
        styleClass="mb-3 message-full-width">
      </p-message>
    }

    @if (uploadState().errorMessage) {
      <p-message 
        severity="error" 
        [text]="uploadState().errorMessage"
        [closable]="true"
        (onClose)="clearMessages()"
        styleClass="mb-3 message-full-width">
      </p-message>
    }

    <!-- ================================ -->
    <!-- JIRA ID INPUT SECTION -->
    <!-- ================================ -->
    
    <div class="input-section">
      <div class="field-group">
        <label for="jiraInput" class="field-label">
          <i class="pi pi-ticket"></i>
          JIRA ID or URL
        </label>
        
        <div class="input-container">
          <input 
            id="jiraInput"
            type="text" 
            pInputText 
            [(ngModel)]="jiraInput"
            [placeholder]="inputPlaceholder()"
            [class.ng-invalid]="jiraInput() && !isValidInput()"
            class="jira-input" 
            autocomplete="off" />
        </div>

        <!-- Validation feedback below input -->
        @if (jiraInput()) {
          <div class="validation-feedback">
            @if (isValidInput()) {
              <div class="validation-success">
                <i class="pi pi-check-circle"></i>
                <span class="validation-text">Valid {{ jiraTypeDisplay() }}</span>
                <p-badge [value]="jiraTypeDisplay()" severity="success" styleClass="ml-2"></p-badge>
              </div>
            } @else {
              <div class="validation-error">
                <i class="pi pi-exclamation-triangle"></i>
                <span class="validation-text">{{ inputErrorMessage() }}</span>
              </div>
            }
          </div>
        }
      </div>
    </div>

    <!-- ================================ -->
    <!-- TEST CYCLE EXECUTIONS SECTION -->
    <!-- ================================ -->
    
    @if (testCycleExecutions().length > 0 || uploadState().showExecutions) {
      <div class="executions-section">
        <div class="executions-header">
          <h4>Test Executions</h4>
          <p-badge [value]="testCycleExecutions().length" severity="info"></p-badge>
        </div>

        @if (uploadState().isUploading) {
          <div class="loading-executions">
            <i class="pi pi-spin pi-spinner"></i>
            <span>Loading executions...</span>
          </div>
        } @else if (testCycleExecutions().length > 0) {
          <div class="executions-table-container">
            <p-table 
              [value]="testCycleExecutions()" 
              [paginator]="true" 
              [rows]="5"
              [showCurrentPageReport]="true"
              currentPageReportTemplate="Showing {first} to {last} of {totalRecords} executions"
              [rowsPerPageOptions]="[5, 10, 25]"
              selectionMode="single"
              [(selection)]="selectedRows"
              dataKey="id"
              styleClass="compact-table">
              
              <ng-template pTemplate="header">
                <tr>
                  <th style="width: 3rem">Select</th>
                  <th>Test Case</th>
                  <th>Execution</th>
                  <th>Status</th>
                </tr>
              </ng-template>
              
              <ng-template pTemplate="body" let-execution>
                <tr [pSelectableRow]="execution">
                  <td>
                    <p-tableRadioButton [value]="execution"></p-tableRadioButton>
                  </td>
                  <td>
                    <a [href]="execution.testcaseUrl" target="_blank" class="external-link">
                      {{ execution.testCaseKey }}
                      <i class="pi pi-external-link"></i>
                    </a>
                  </td>
                  <td>
                    <a [href]="execution.keyUrl" target="_blank" class="external-link">
                      {{ execution.key }}
                      <i class="pi pi-external-link"></i>
                    </a>
                  </td>
                  <td>
                    <p-badge 
                      [value]="execution.status" 
                      [severity]="getStatusSeverity(execution.status)">
                    </p-badge>
                  </td>
                </tr>
              </ng-template>
              
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="4" class="text-center p-3">No executions found</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        }
      </div>
    }

    <!-- ================================ -->
    <!-- UPLOAD PROGRESS (only shows in upload mode) -->
    <!-- ================================ -->
    
    @if (uploadState().isUploading && uploadState().uploadProgress > 0 && mode === 'upload') {
      <div class="upload-progress-section">
        <div class="progress-header">
          <span>Upload Progress</span>
          <span class="progress-percentage">{{ uploadState().uploadProgress }}%</span>
        </div>
        <p-progressBar 
          [value]="uploadState().uploadProgress"
          styleClass="mb-2">
        </p-progressBar>
      </div>
    }

    <!-- ================================ -->
    <!-- ACTION BUTTONS (modified for dual mode) -->
    <!-- ================================ -->
    
    <div class="dialog-footer">
      <div class="button-group">
        
        <!-- Cancel Button -->
        <button 
          type="button"
          class="p-button p-button-text"
          (click)="onDialogHide()"
          [disabled]="uploadState().isUploading">
          Cancel
        </button>

        <!-- CHANGED: Show executions button (only for test cycles and upload mode) -->
        @if (detectionResult()?.type === 'test-cycle' && 
              testCycleExecutions().length === 0 && 
              !uploadState().showExecutions && 
              !uploadState().isUploading &&
              mode === 'upload') {
          <button 
            type="button"
            class="p-button p-button-outlined"
            (click)="getAssociatedExecutions()">
            <i class="pi pi-list"></i>
            Show Executions
          </button>
        }

        <!-- MAIN ACTION BUTTON (modified text based on mode) -->
        <button 
          type="button"
          class="p-button"
          [class.p-button-success]="mode === 'upload'"
          [class.p-button-primary]="mode === 'search'"
          (click)="performAction()"
          [disabled]="!isValidInput() || uploadState().isUploading">
          
          <!-- Icon based on mode -->
          @if (mode === 'upload') {
            <i class="pi pi-upload"></i>
          } @else {
            <i class="pi pi-search"></i>
          }
          
          <!-- Dynamic text -->
          {{ actionButtonText() }}
        </button>
      </div>
    </div>

  </div>
</p-dialog>

<!-- ================================ -->
<!-- ADD: Method for status severity (add to component) -->
<!-- ================================ -->
<style>
/* Keep all existing styles and add minimal new ones */

.external-link {
  color: var(--primary-color);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
}

.external-link:hover {
  text-decoration: underline;
}

.compact-table {
  font-size: 0.875rem;
}

.compact-table .p-datatable-tbody > tr > td {
  padding: 0.5rem;
}

/* Button styling for dual mode */
.p-button-primary {
  background: var(--primary-color);
  border-color: var(--primary-color);
}

.p-button-success {
  background: var(--green-500);
  border-color: var(--green-500);
}

/* Dark mode support */
.app-dark .external-link {
  color: var(--primary-color-text);
}
</style>