<p-dialog 
  [header]="dialogTitle()" 
  [visible]="visible" 
  [modal]="true" 
  [style]="{ width: '600px' }"
  [height]="testCycleExecutions().length > 0 ? '700px' : 'auto'"
  [maximizable]="false"
  [closable]="true"
  [draggable]="true"
  [resizable]="false"
  styleClass="jira-upload-dialog"
  (onHide)="onDialogHide()">

  <div class="jira-dialog-content">
    
    <!-- ================================ -->
    <!-- SUCCESS/ERROR MESSAGES (unchanged) -->
    <!-- ================================ -->
    
    @if (uploadState().successMessage) {
      <p-message 
        severity="success" 
        [text]="uploadState().successMessage"
        [closable]="true"
        (onClose)="clearMessages()"
        styleClass="mb-3 message-full-width">
      </p-message>
    }

    @if (uploadState().errorMessage) {
      <p-message 
        severity="error" 
        [text]="uploadState().errorMessage"
        [closable]="true"
        (onClose)="clearMessages()"
        styleClass="mb-3 message-full-width">
      </p-message>
    }

    <!-- ================================ -->
    <!-- JIRA ID INPUT SECTION (unchanged) -->
    <!-- ================================ -->
    
    <div class="input-section">
      <div class="field-group">
        <label for="jiraInput" class="field-label">
          <i class="pi pi-ticket"></i>
          JIRA ID or URL
        </label>
        
        <div class="input-container">
          <input 
            id="jiraInput"
            type="text" 
            pInputText 
            [(ngModel)]="jiraInput"
            [placeholder]="inputPlaceholder()"
            [class.ng-invalid]="jiraInput() && !isValidInput()"
            class="jira-input" 
            autocomplete="off" />
        </div>

        <!-- Validation feedback below input (unchanged) -->
        @if (jiraInput()) {
          <div class="validation-feedback">
            @if (isValidInput()) {
              <div class="validation-success">
                <i class="pi pi-check-circle"></i>
                <span class="validation-text">Valid {{ jiraTypeDisplay() }}</span>
                <p-badge [value]="jiraTypeDisplay()" severity="success" styleClass="ml-2"></p-badge>
              </div>
            } @else {
              <div class="validation-error">
                <i class="pi pi-exclamation-triangle"></i>
                <span class="validation-text">{{ inputErrorMessage() }}</span>
              </div>
            }
          </div>
        }
      </div>
    </div>

    <!-- ================================ -->
    <!-- TEST CYCLE EXECUTIONS SECTION (enhanced) -->
    <!-- ================================ -->
    
    @if (testCycleExecutions().length > 0) {
      <div class="executions-section">
        <div class="executions-header">
          <h4>Test Executions</h4>
          <p-badge [value]="testCycleExecutions().length" severity="info"></p-badge>
        </div>

        @if (uploadState().isUploading) {
          <div class="loading-executions">
            <i class="pi pi-spin pi-spinner"></i>
            <span>Loading executions...</span>
          </div>
        } @else {
          <div class="executions-table-container">
            <p-table 
              [value]="testCycleExecutions()" 
              [paginator]="true" 
              [rows]="5"
              [showCurrentPageReport]="true"
              currentPageReportTemplate="Showing {first} to {last} of {totalRecords} executions"
              [rowsPerPageOptions]="[5, 10, 25]"
              selectionMode="single"
              [(selection)]="selectedExecution"
              dataKey="id"
              styleClass="compact-table">
              
              <ng-template pTemplate="header">
                <tr>
                  <th style="width: 3rem">Select</th>
                  <th>Test Case</th>
                  <th>Execution</th>
                  <th>Status</th>
                </tr>
              </ng-template>
              
              <ng-template pTemplate="body" let-execution>
                <tr [pSelectableRow]="execution">
                  <td>
                    <p-tableRadioButton [value]="execution"></p-tableRadioButton>
                  </td>
                  <td>
                    <a [href]="execution.testcaseUrl" target="_blank" class="external-link">
                      {{ execution.testCaseKey }}
                      <i class="pi pi-external-link"></i>
                    </a>
                  </td>
                  <td>
                    <a [href]="execution.keyUrl" target="_blank" class="external-link">
                      {{ execution.key }}
                      <i class="pi pi-external-link"></i>
                    </a>
                  </td>
                  <td>
                    <p-badge 
                      [value]="execution.status" 
                      [severity]="getStatusSeverity(execution.status)">
                    </p-badge>
                  </td>
                </tr>
              </ng-template>
              
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="4" class="text-center p-3">No executions found</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        }
      </div>
    }

    <!-- ================================ -->
    <!-- UPLOAD PROGRESS (unchanged - only shows in upload mode) -->
    <!-- ================================ -->
    
    @if (uploadState().isUploading && uploadState().uploadProgress > 0 && mode === 'upload') {
      <div class="upload-progress-section">
        <div class="progress-header">
          <span>Upload Progress</span>
          <span class="progress-percentage">{{ uploadState().uploadProgress }}%</span>
        </div>
        <p-progressBar 
          [value]="uploadState().uploadProgress"
          styleClass="mb-2">
        </p-progressBar>
      </div>
    }

    <!-- ================================ -->
    <!-- ACTION BUTTONS (completely redesigned for dual mode) -->
    <!-- ================================ -->
    
    <div class="dialog-footer">
      <div class="button-group">
        
        <!-- ENHANCED: Show executions button (only for test cycles in upload mode) -->
        @if (detectionResult()?.type === 'test-cycle' && 
              testCycleExecutions().length === 0 && 
              !uploadState().isUploading &&
              mode === 'upload') {
          <button 
            type="button"
            class="p-button p-button-outlined"
            (click)="getAssociatedExecutions()">
            <i class="pi pi-list"></i>
            Show Executions
          </button>
        }

        <!-- ENHANCED: Primary action button (execution-specific) -->
        @if (selectedExecution() || !showBothActions()) {
          <button 
            type="button"
            class="p-button"
            [class.p-button-success]="mode === 'upload'"
            [class.p-button-primary]="mode === 'search'"
            (click)="performPrimaryAction()"
            [disabled]="!isValidInput() || uploadState().isUploading">
            
            <!-- Icon based on mode -->
            @if (mode === 'upload') {
              <i class="pi pi-upload"></i>
            } @else {
              <i class="pi pi-search"></i>
            }
            
            <!-- Dynamic text -->
            {{ primaryActionText() }}
          </button>
        }

        <!-- ENHANCED: Secondary action button (cycle-level, when execution is selected) -->
        @if (showBothActions()) {
          <button 
            type="button"
            class="p-button"
            [class.p-button-success]="mode === 'upload'"
            [class.p-button-primary]="mode === 'search'"
            (click)="performPrimaryAction()"
            [disabled]="!isValidInput() || uploadState().isUploading">
            
            @if (mode === 'upload') {
              <i class="pi pi-upload"></i>
            } @else {
              <i class="pi pi-search"></i>
            }
            
            {{ primaryActionText() }}
          </button>

          <button 
            type="button"
            class="p-button p-button-outlined"
            [class.p-button-success]="mode === 'upload'"
            [class.p-button-primary]="mode === 'search'"
            (click)="performSecondaryAction()"
            [disabled]="!isValidInput() || uploadState().isUploading">
            
            @if (mode === 'upload') {
              <i class="pi pi-upload"></i>
            } @else {
              <i class="pi pi-search"></i>
            }
            
            {{ secondaryActionText() }}
          </button>
        }

        <!-- Cancel Button - positioned on the right -->
        <button 
          type="button"
          class="p-button p-button-text cancel-button"
          (click)="onCancel()"
          [disabled]="uploadState().isUploading">
          Cancel
        </button>
        
      </div>
    </div>

  </div>
</p-dialog>