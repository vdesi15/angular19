<!-- batch-viewer.component.html - Updated with professional styling and table improvements -->
<div class="batch-viewer-container">
  <!-- Header with time range selector and streaming controls -->
  <div class="batch-header">
    <div class="header-left">
      <h2>U & M Timeline Search</h2>
      
      <!-- Streaming indicator and control -->
      @if(search.isStreaming) {
        <div class="streaming-indicator">
          <button 
            pButton 
            type="button" 
            class="p-button-sm streaming-control-btn" 
            [ngClass]="{
              'p-button-success': !isStopButtonHovered(),
              'p-button-danger': isStopButtonHovered()
            }" 
            (mouseenter)="isStopButtonHovered.set(true)" 
            (mouseleave)="isStopButtonHovered.set(false)"
            (click)="stopStreaming($event)" 
            pTooltip="Stop the live data stream" 
            tooltipPosition="top">

            @if (isStopButtonHovered()) {
              <span class="flex align-items-center gap-2">
                <i class="pi pi-stop-circle"></i>
                <span>Stop</span>
              </span>
            } @else {
              <span class="flex align-items-center gap-2">
                <i class="pi pi-spin pi-spinner"></i>
                <span>Streaming...</span>
              </span>
            }
          </button>
        </div>
      }
    </div>
    
    <!-- IMPROVED: Time range inline with proper button styling -->
    <div class="time-range-selector">
      <span class="time-range-label">Time Range:</span>
      <div class="time-range-button-group">
        @for (range of timeRanges; track $index; let first = $first; let last = $last) {
          <button
            pButton
            type="button"
            [label]="range"
            [disabled]="selectedTimeRange() === range"
            [ngClass]="{
              'p-button-primary': selectedTimeRange() === range,
              'p-button-outlined': selectedTimeRange() !== range,
              'first-button': first,
              'last-button': last,
              'middle-button': !first && !last
            }"
            class="time-range-button"
            (click)="onTimeRangeClick(range, $event)"
            pTooltip="Change time range for batch data"
            tooltipPosition="top">
          </button>
        }
      </div>
    </div>
  </div>

  <!-- IMPROVED: Indented content wrapper -->
  <div class="batch-content">
    <h3>Following are U & M data</h3>
    
    <!-- IMPROVED: Professional accordion implementation with proper indentation -->
    <div class="custom-accordions">
      @for (data of batchData(); track trackByTxnId($index, data)) {
        <div class="custom-accordion-panel" 
             [ngClass]="[getAccordionClass(data), isAccordionExpanded(data.api_txnid) ? 'expanded' : '']">
          
          <!-- Custom accordion header with professional styling -->
          <div 
            class="custom-accordion-header" 
            [style]="getAccordionHeaderStyle(data)"
            (click)="toggleAccordion(data.api_txnid, $event)">
            
            <div class="accordion-title-section">
              <i class="pi" 
                 [ngClass]="isAccordionExpanded(data.api_txnid) ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
              
              <!-- Professional title with bold API name -->
              <span class="accordion-title">
                <span class="timestamp">[{{ data.time | date:'short' }}]</span>
                <strong class="api-name">{{ data.api_name }}</strong>
                <span class="details">
                  VLine:<span class="value">{{ data.v_line }}</span>
                  Min:<span class="value">{{ data.min }}</span>
                  UG:<span class="value">{{ data.good_u }}</span>
                  MG:<span class="value">{{ data.good_m }}</span>
                  All Rules Passed:<span class="value" [ngClass]="calculateAllRulesPassed(data) ? 'success' : 'error'">
                    {{ calculateAllRulesPassed(data) }}
                  </span>
                </span>
              </span>
            </div>
          </div>
          
          <!-- IMPROVED: Accordion content with proper indentation and background -->
          @if (isAccordionExpanded(data.api_txnid)) {
            <div class="custom-accordion-content">
              
              <!-- Transaction ID with clickable link -->
              <div class="content-section transaction-info">
                <p>
                  <strong>Txn id:</strong> 
                  <a [href]="buildTransactionSearchLink(data.api_txnid)" 
                     target="_blank" 
                     class="transaction-link"
                     pTooltip="Click to search for this transaction">
                    {{ data.api_txnid }}
                    <i class="pi pi-external-link"></i>
                  </a>
                </p>
              </div>

              <!-- FIXED: Rules section using column definitions like aggregation -->
              @if (data.rules && data.rules.length > 0) {
                <div class="content-section rules-section">
                  <h4>Rules</h4>
                  <p-table 
                    [value]="data.rules" 
                    [scrollable]="true" 
                    scrollHeight="200px"
                    styleClass="p-datatable-sm professional-table">
                    
                    <ng-template pTemplate="header">
                      <tr>
                        @for (col of rulesColumns(); track trackByField($index, col)) {
                          <th [style.width]="col.width || 'auto'">
                            <div class="header-content">
                              <span>{{ col.displayName }}</span>
                              @if (col.enableFiltering) {
                                <input 
                                  pInputText 
                                  type="text" 
                                  [placeholder]="'Filter ' + col.displayName.toLowerCase() + '...'"
                                  class="header-filter-input"
                                  (input)="onRuleFilter($event, col.field)" />
                              }
                            </div>
                          </th>
                        }
                      </tr>
                    </ng-template>
                    
                    <ng-template pTemplate="body" let-rule>
                      <tr>
                        @for (col of rulesColumns(); track trackByField($index, col)) {
                          <td>
                            @if (col.field === 'pass') {
                              <p-tag 
                                [value]="getFieldValue(rule, col.field) ? 'PASS' : 'FAIL'" 
                                [severity]="getFieldValue(rule, col.field) ? 'success' : 'danger'">
                              </p-tag>
                            } @else if (col.field === 'message') {
                              <span 
                                class="rule-message clickable" 
                                (click)="openMessageEditor(getFieldValue(rule, col.field))"
                                pTooltip="Click to view full message">
                                {{ getFieldValue(rule, col.field) | slice:0:100 }}{{ getFieldValue(rule, col.field)?.length > 100 ? '...' : '' }}
                              </span>
                            } @else {
                              <span [innerHTML]="getFieldValue(rule, col.field) | transform:col.transform"></span>
                            }
                          </td>
                        }
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              }

              <!-- IMPROVED: Aggregation section with proper column sizing -->
              @if (data.agg && data.agg.length > 0) {
                <div class="content-section aggregation-section">
                  <h4>Aggregation Data</h4>
                  <p-table 
                    [value]="data.agg" 
                    [scrollable]="true" 
                    scrollHeight="200px"
                    styleClass="p-datatable-sm professional-table">
                    
                    <ng-template pTemplate="header">
                      <tr>
                        @for (col of aggColumns(); track trackByField($index, col)) {
                          <th [style.width]="col.width || 'auto'">
                            <div class="header-content">
                              <span>{{ col.displayName }}</span>
                              @if (col.enableFiltering) {
                                <input 
                                  pInputText 
                                  type="text" 
                                  [placeholder]="'Filter ' + col.displayName.toLowerCase() + '...'"
                                  class="header-filter-input"
                                  (input)="onAggFilter($event, col.field)" />
                              }
                            </div>
                          </th>
                        }
                      </tr>
                    </ng-template>
                    
                    <ng-template pTemplate="body" let-agg>
                      <tr>
                        @for (col of aggColumns(); track trackByField($index, col)) {
                          <td>
                            <span [innerHTML]="getFieldValue(agg, col.field) | transform:col.transform"></span>
                          </td>
                        }
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              }

              <!-- Summary section with filtering -->
              @if (data.summary && data.summary.length > 0) {
                <div class="content-section summary-section">
                  <div class="summary-header">
                    <h4>Summary Data</h4>
                    
                    <!-- Group selector -->
                    @if (availableGroupColumns().length > 0) {
                      <div class="group-selector">
                        <label for="groupColumns">Group by:</label>
                        <p-multiSelect
                          id="groupColumns"
                          [options]="availableGroupColumns()"
                          [(ngModel)]="selectedGroupColumns"
                          optionLabel="label"
                          optionValue="value"
                          placeholder="Select grouping columns"
                          [maxSelectedLabels]="2"
                          [showClear]="true">
                        </p-multiSelect>
                      </div>
                    }
                  </div>

                  <!-- Summary table with filtering -->
                  <p-table 
                    [value]="data.summary" 
                    [scrollable]="true" 
                    scrollHeight="300px"
                    [globalFilterFields]="filterableColumns().map(col => col.field)"
                    styleClass="p-datatable-sm professional-table"
                    #summaryTable>
                    
                    <ng-template pTemplate="caption">
                      <div class="table-header">
                        <span>Total Records: {{ data.summary.length }}</span>
                        <span class="p-input-icon-left">
                          <i class="pi pi-search"></i>
                          <input 
                            pInputText 
                            type="text" 
                            placeholder="Global search..." 
                            class="global-search-input"
                            (input)="summaryTable.filterGlobal($any($event.target).value, 'contains')" />
                        </span>
                      </div>
                    </ng-template>
                    
                    <ng-template pTemplate="header">
                      <tr>
                        @for (col of summaryColumns(); track trackByField($index, col)) {
                          <th [style.width]="col.width || 'auto'">
                            <div class="header-content">
                              <span>{{ col.displayName }}</span>
                              @if (col.enableFiltering) {
                                <input 
                                  pInputText 
                                  type="text" 
                                  [placeholder]="'Filter ' + col.displayName.toLowerCase() + '...'"
                                  class="header-filter-input"
                                  (input)="onSummaryFilter($event, col.field)" />
                              }
                            </div>
                          </th>
                        }
                      </tr>
                    </ng-template>
                    
                    <ng-template pTemplate="body" let-summary let-rowGroup="rowgroup" let-rowspan="rowspan">
                      <tr>
                        @for (col of summaryColumns(); track trackByField($index, col)) {
                          <td [attr.rowspan]="rowspan">
                            @if (col.field === selectedGroupColumns()[0] && rowGroup) {
                              <strong>{{ getFieldValue(summary, col.field) }}</strong>
                              <span class="group-count">({{ calculateGroupTotal(data, summary) }})</span>
                            } @else {
                              <span [innerHTML]="getFieldValue(summary, col.field) | transform:col.transform"></span>
                            }
                          </td>
                        }
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </div>
</div>

<!-- Editor Dialog for rule messages -->
<app-editor-dialog
  [visible]="showEditorDialog()"
  [title]="editorTitle()"
  [content]="editorContent()"
  (visibleChange)="showEditorDialog.set($event)">
</app-editor-dialog>