<div class="batch-viewer-container">
  <!-- Header with time range selector -->
  <div class="batch-header">
    <h2>U & M Timeline Search</h2>
    <div class="time-range-selector">
      <span class="time-range-label">Time Range:</span>
      @for (range of timeRanges; track range) {
        <a [class.active]="selectedTimeRange() === range" 
           (click)="onTimeRangeClick(range, $event)"
           class="time-range-link">
          {{ range }}
        </a>
      }
    </div>
  </div>

  <div class="batch-content">
    <h3>Following are U & M data</h3>
    
    <!-- Batch Data Accordions -->
    <p-accordion [multiple]="true" styleClass="batch-accordions">
      @for (data of batchData(); track data.api_txnid) {
        <p-accordion-panel [ngClass]="getAccordionClass(data)">
          <p-accordion-header>
            <span [innerHTML]="getAccordionTitle(data)"></span>
          </p-accordion-header>
          <p-accordion-content>
            <div class="txn-info">
              <p><strong>Txn id:</strong> {{ data.api_txnid }}</p>
              <p><strong>DLEnabled:</strong> {{ data.dl_enable }}</p>
            </div>

            <div class="row">
              <!-- Rules Table (30%) -->
              <div class="col-4">
                <h4>Rule Table</h4>
                <p-table [value]="data.rules" styleClass="rules-table">
                  <ng-template pTemplate="header">
                    <tr>
                      @for (col of rulesColumns(); track col.id) {
                        @if (col.visible) {
                          <th [style.width]="col.width">{{ col.displayName }}</th>
                        }
                      }
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-rule>
                    <tr>
                      @for (col of rulesColumns(); track col.id) {
                        @if (col.visible) {
                          <td [style.width]="col.width"
                              [ngClass]="col.field === 'pass' ? getRuleCellClass(rule.pass) : ''"
                              [class.clickable-cell]="col.onClick"
                              (click)="col.onClick && col.field === 'message' ? onRuleMessageClick(rule) : null">
                            {{ getFieldValue(rule, col.field) | transform:col.transform:rule }}
                          </td>
                        }
                      }
                    </tr>
                  </ng-template>
                </p-table>
              </div>

              <!-- Agg Table (70%) -->
              <div class="col-8">
                <h4>Agg Table</h4>
                <p-table [value]="data.agg" styleClass="agg-table">
                  <ng-template pTemplate="header">
                    <tr>
                      @for (col of aggColumns(); track col.id) {
                        @if (col.visible) {
                          <th [style.width]="col.width">{{ col.displayName }}</th>
                        }
                      }
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-agg>
                    <tr>
                      @for (col of aggColumns(); track col.id) {
                        @if (col.visible) {
                          <td [style.width]="col.width">
                            {{ getFieldValue(agg, col.field) | transform:col.transform:agg }}
                          </td>
                        }
                      }
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </div>

            <!-- Summary Table (100%) -->
            <div class="summary-section">
              <h4>U & M Summary Table</h4>
              
              <div class="group-selector">
                <label>Group Cols By:</label>
                <p-multiSelect 
                  [(ngModel)]="selectedGroupColumns"
                  [options]="availableGroupColumns"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Select columns to group by">
                </p-multiSelect>
              </div>

              <p-table [value]="data.summary" 
                       [rowGroupMode]="selectedGroupColumns().length > 0 ? 'rowspan' : null"
                       [groupRowsBy]="selectedGroupColumns()"
                       styleClass="summary-table">
                <ng-template pTemplate="header">
                  <tr>
                    @for (col of summaryColumns(); track col.id) {
                      @if (col.visible) {
                        <th [style.width]="col.width">{{ col.displayName }}</th>
                      }
                    }
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-summary let-rowgroup="rowgroup">
                  <tr>
                    @for (col of summaryColumns(); track col.id) {
                      @if (col.visible) {
                        @if (rowgroup && selectedGroupColumns().includes(col.field)) {
                          <td [style.width]="col.width">
                            {{ getFieldValue(summary, col.field) | transform:col.transform:summary }}
                          </td>
                        } @else if (!rowgroup) {
                          <td [style.width]="col.width">
                            {{ getFieldValue(summary, col.field) | transform:col.transform:summary }}
                          </td>
                        }
                      }
                    }
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </p-accordion-content>
        </p-accordion-panel>
      }
    </p-accordion>
  </div>
</div>

<!-- Editor Dialog -->
<app-editor-dialog
  [(visible)]="showEditorDialog"
  [title]="editorTitle()"
  [content]="editorContent()"
  [readOnly]="true">
</app-editor-dialog>