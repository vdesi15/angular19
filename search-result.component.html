<!-- search-result.component.html - Custom accordion preserving ALL your existing logic -->
<div class="custom-search-result" [class.expanded]="search.isExpanded">
  <!-- Custom Accordion Header -->
  <div class="result-header" 
       (click)="toggleAccordion()" 
       [class.active]="search.isExpanded"
       role="button" 
       tabindex="0"
       (keydown.enter)="toggleAccordion()"
       (keydown.space)="toggleAccordion()">
    
    <div class="accordion-header">
      <div class="header-left">
        <!-- Expand/Collapse Icon -->
        <i class="toggle-icon pi" 
           [class.pi-chevron-right]="!search.isExpanded"
           [class.pi-chevron-down]="search.isExpanded"></i>
        
        <span class="font-bold text-lg mr-3">{{ search.title }}</span>
        @if (hasTransactionDetails()) {
          <p-tag value="Transaction Details" severity="info" size="small" class="mr-2"></p-tag>
        }
        <span class="text-sm text-color-secondary ml-2">{{ recordsSummary() }}</span>
      </div>
      
      <!-- FIXED: Buttons container with proper click isolation -->
      <div class="header-right" (click)="$event.stopPropagation()">
        <!-- Streaming Control Button -->
        @if(search.isStreaming) {
          <button pButton type="button" class="p-button-sm streaming-control-btn" [ngClass]="{
              'p-button-success': !isStopButtonHovered(),
              'p-button-danger': isStopButtonHovered()
            }" (mouseenter)="isStopButtonHovered.set(true)" (mouseleave)="isStopButtonHovered.set(false)"
            (click)="stopStreaming($event)" pTooltip="Stop the live data stream" tooltipPosition="top">

            @if (isStopButtonHovered()) {
              <span class="flex align-items-center gap-2">
                <i class="pi pi-stop-circle"></i>
                <span>Stop</span>
              </span>
            } @else {
              <span class="flex align-items-center gap-2">
                <i class="pi pi-spin pi-spinner"></i>
                <span>Streaming...</span>
              </span>
            }
          </button>
        }

        <!-- Close Panel Button -->
        <button pButton type="button" icon="pi pi-times"
          class="p-button-text p-button-rounded p-button-danger p-button-sm" pTooltip="Close this result panel"
          (click)="closePanel($event)">
        </button>
      </div>
    </div>
  </div>

  <!-- Custom Accordion Content with slide animation -->
  <div class="result-content" 
       [@slideToggle]="search.isExpanded ? 'expanded' : 'collapsed'"
       [style.overflow]="search.isExpanded ? 'visible' : 'hidden'">
    
    <!-- ALL YOUR EXISTING CONTENT PRESERVED EXACTLY -->
    <div class="content-wrapper" *ngIf="search.isExpanded" [@fadeInContent]>
      <!-- Show different toolbars based on search type -->
      @if (!search.error) {
        
        <!-- Streaming Toolbar for SSE searches -->
        @if (shouldShowStreamingToolbar()) {
          <app-streaming-toolbar 
            [allAvailableColumns]="allColumnsForViewType()"
            [currentlyVisibleColumns]="streamingVisibleColumns()"
            (visibleColumnsChange)="onStreamingColumnsChange($event)" 
            (resetColumns)="resetStreamingColumns()"
            [availableFilterValues]="search.aggregatedFilterValues" 
            [appliedFilters]="search.streamFilters ?? []"
            (filtersChange)="onStreamFiltersChange($event)">
          </app-streaming-toolbar>
        }

        <!-- Transaction Toolbar for transaction searches -->
        @if (shouldShowTransactionToolbar()) {
          <app-transaction-toolbar 
            [views]="availableViews()" 
            [selectedView]="selectedViewId()"
            (viewChange)="onViewChange($event)">
          </app-transaction-toolbar>
        }

      }

      <div class="result-content-wrapper">
        @if (search.isLoading && search.data.length === 0) {
          <!-- Loading skeleton with visible columns only -->
          <app-table-skeleton 
            [columns]="finalVisibleColumns()" 
            [rowCount]="10">
          </app-table-skeleton>
        } @else if (search.error) {
          <!-- Error state -->
          <div class="error-container">
            <p class="p-3 text-red-500 font-bold">
              <i class="pi pi-exclamation-circle mr-2"></i>{{ search.error }}
            </p>
            <button pButton type="button" label="Retry" icon="pi pi-refresh" class="p-button-sm p-button-outlined"
              (click)="retrySearch()">
            </button>
          </div>
        } @else if (hasTransactionDetails()) {
          <!-- Split layout for transaction details - YOUR 70%/30% SPLIT PRESERVED -->
          <div class="transaction-details-layout">
            <!-- 80% - Log Viewer -->
            <div class="log-viewer-section">
              <app-log-viewer #logViewer 
                [searchInstance]="search" 
                [visibleColumns]="finalVisibleColumns()"
                (rowDrilldown)="onDrilldown($event)" 
                (filteredCountChange)="updateFilteredCount($event)">
              </app-log-viewer>
            </div>
            
            <!-- 20% - Transaction Timeline -->
            <div class="timeline-section">
              <app-transaction-timeline 
                [transactionDetails]="search.transactionDetails"
                [transactionId]="search.query"
                class="transaction-timeline">
              </app-transaction-timeline>
            </div>
          </div>
        } @else if (shouldShowLogViewer()) {
          @if (!areGlobalFiltersValid()) {
            <app-filter-validation></app-filter-validation>
          } @else {
            <app-log-viewer #logViewer 
              [searchInstance]="search" 
              [visibleColumns]="finalVisibleColumns()"
              (rowDrilldown)="onDrilldown($event)" 
              (filteredCountChange)="updateFilteredCount($event)">
            </app-log-viewer>
          }
        }

        <!-- Add Batch Viewer section in the result content wrapper, after the log viewer checks -->
        @else if (shouldShowBatchViewer()) {
          <!-- Batch viewer for batch searches -->
          <app-batch-viewer 
            [search]="search">
          </app-batch-viewer>
        }
      </div>
    </div>
  </div>
</div>