<p-accordion [multiple]="true" [activeIndex]="search.isExpanded ? 0 : -1" styleClass="result-accordion compact">
  <p-accordion-panel>
    <p-accordion-header>
      <div class="accordion-header" (click)="toggleExpansion()">
        <div class="header-left">
          <span class="font-bold text-lg mr-3">{{ search.title }}</span>
          <span class="text-sm text-color-secondary ml-2">{{ recordsSummary() }}</span>
        </div>
        <div class="header-right">
          @if(search.isStreaming) {
            <span class="streaming-indicator text-sm text-color-secondary">
              <i class="pi pi-spin pi-spinner mr-2"></i>
              Streaming...
            </span>
            <button pButton type="button" icon="pi pi-stop-circle" label="Stop" class="p-button-sm p-button-danger mr-2" 
                    pTooltip="Stop the live data stream"
                    (click)="orchestrator.stopSseStream(search.id); $event.stopPropagation()"></button>
          }
          <button pButton type="button" icon="pi pi-times" class="p-button-text p-button-rounded p-button-danger" 
                  pTooltip="Close Panel" 
                  (click)="orchestrator.closeSearch(search.id); $event.stopPropagation()"></button>
        </div>
      </div>
    </p-accordion-header>
    <p-accordion-content>
      @if(search.type === 'transaction') {
        <app-transaction-toolbar 
          [availableViews]="availableViews()" 
          [selectedViewId]="selectedViewId()"
          (viewChange)="selectedViewId.set($event)">
        </app-transaction-toolbar>
      } @else {
        <app-streaming-toolbar
          [allAvailableColumns]="allColumnsForViewType()"
          [currentlyVisibleColumns]="visibleColumns()"
          (visibleColumnsChange)="onStreamingColumnsChange($event)"
          (reset)="resetStreamingColumns()">
        </app-streaming-toolbar>
      }
      
      <div class="result-content-wrapper">
        @if (search.isLoading && search.data.length === 0) {
          <app-table-skeleton [columns]="allColumnsForViewType()"></app-table-skeleton>
        } @else if (search.error) {
          <p class="p-3 text-red-500 font-bold"><i class="pi pi-exclamation-circle mr-2"></i>{{ search.error }}</p>
        } @else {
          <app-log-viewer
            [searchInstance]="search"
            [visibleColumns]="visibleColumns()"
            (rowDrilldown)="onDrilldown($event)">
          </app-log-viewer>
        }
      </div>
    </p-accordion-content>
  </p-accordion-panel>
</p-accordion>